<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width initial-scale=1"> <meta name="author" content="ikiApps LLC, 粋アプリ, d108(सोऽहम्)"> <meta name="description" content=" Figure 1: MVC vs MVVM. MVVM is roughly the same as MVC with the addition of a data layer in the form of the View Model that takes over interactin..."> <title>MVVM in Swift with ReactiveCocoa 4</title> <link href="/assets/themes/bootstrap/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet"> <!--[if lt IE 9]> <script src="/assets/themes/bootstrap/resources/respond/Respond.min.js"></script> <![endif]--> <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed"> <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed"> <link rel="stylesheet" href="/css/main.css" type="text/css"> <link rel="canonical" href="/experiences/2016/01/15/mvvm-in-swift-with-reactivecocoa4"> <link rel="shortcut icon" href="/favicon.ico"> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-40712418-2', 'auto'); ga('send', 'pageview'); </script> <script src="/js/jquery-3.2.0.min.js"></script> </head> <body> <nav class="navbar navbar-default" role="navigation"> <div class="container"> <div class="navbar-header"> <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <div class="navbar-image"><a href="/"><img src="/assets/themes/bootstrap/iki-circle-logo.png" width="40"/></a></div> <a class="navbar-brand" href="/">ikiApps</a> </div> <div class="collapse navbar-collapse navbar-ex1-collapse"> <ul class="nav navbar-nav"> <li><a href="/blog/">Blog</a></li> <li><a href="/archive">Archive</a></li> <li><a href="/tags">Tags</a></li> <li><a href="/search/">Search</a></li> </ul> </div> </div> </nav> <div class="container"> <div class="page-header"> <h1>MVVM in Swift with ReactiveCocoa 4 <br/><small>Pulling Random Photos From Parse and Updating Them in the Background</small></h1> </div> <div class="row post-full"> <div class="col-md-12"> <div class="date"> <span>15 January 2016</span> </div> <div class="content"> <p> <figure class="image"><img src="/img/2016-01-15-mvvm-in-swift-with-reactivecocoa4/mvc-vs-mvvm-diagram.png" alt="Figure 1: MVC vs MVVM.MVVM is roughly the same as MVC with the addition of a data layer in the form of the View Model that takes over interacting with the Model layer to provide data for presentation by the View layer." /> <figcaption><strong>Figure 1: MVC vs MVVM.</strong> MVVM is roughly the same as MVC with the addition of a data layer in the form of the View Model that takes over interacting with the Model layer to provide data for presentation by the View layer.</figcaption> </figure> </p> <p>MVVM and MVC are generalizations of real-world architectures. In the real world, an app’s architecture may not exactly fit a single paradigm. Layers indicate a separation of responsibility and a model architecture can be adapted as necessary to a specific application.</p> <p>I like to think of MVC and MVVM as representing the minimal amount of architectural separation necessary to manage a functioning app. With experience, you will create your own distinct layers that go beyond these fundamental paradigms to manage the features in your app.</p> <p>For example, you might need to add a data synchronization layer or a network caching layer. Management of external resources is something that you’ll find falls outside of these model application architectures.</p> <p><strong>There is no requirement to use MVVM if you are using RAC4.</strong> It just happens that RAC integrates well with an MVVM architecture. This is one of the the reasons, I believe, that MVVM has become associated with RAC4.</p> <p>I’d like to share my insights into MVVM and how it can be implemented in Swift with ReactiveCocoa 4. I provide code excerpts from a working demonstration app to serve as a concrete example of an actual implementation.</p> <h2 id="about-mvvm">About MVVM</h2> <p>MVVM fits the same format as MVC with the difference being that an additional data layer, known as the <strong>View Model (VM)</strong>, is added to the architecture. <strong>Figure 1</strong> illustrates this viewpoint of mine.</p> <p><strong>All of the data that is to be shown in the UI first goes through the View Model instead of going directly to a view controller.</strong> The VM also takes over some of the functions of the controller layer in a standard MVC setup. In iOS and OS X, the view controller still serves to manage views. Since the VM is the primary change away from MVC, I’m going to focus most of my discussion on it.</p> <h2 id="benefits-of-the-view-model">Benefits of the View Model</h2> <p>Due to the data now being handled by the VM, instead of being handled by view controllers, the controller layer no longer needs to access the model layer. This reduces the responsibility of view controllers such that <em>they only need to be concerned about handling views.</em></p> <p>Overall, this results in a greater balance in the distribution of functions amongst the different code layers. The benefit of this is clearer code offering the possibility of easier maintenance. In contrast, with MVC, view controllers tend to get bloated with data handling functions and view controlling functions making them difficult to manage. With MVVM, view controllers tend to be reduced in size.</p> <p>All of this talk gives you an idea of what to expect. Let’s look at some code that actually implements an MVVM architecture.</p> <h2 id="a-common-problem-scenario">A common problem scenario</h2> <p>To keep things relevant, the problem that I’ll address in my example is having an app that fetches photos from a backend. This scenario is representative of many network-backed apps where RAC4 can offer significant advantages due to reducing complexity in handling compound asynchronous operations.</p> <p>This situation highlights common problems that developers face with regard to user experience and performance. Photos are often not ready for immediate display due to the need for them to be retrieved from the network. The time delay imposed by these retrievals can have a negative effect on app performance if any of these operations block a critical thread such as the main UI thread. There can also be a visible delay where the user can see the photo loading into place. This may detract from the overall user experience of your app.</p> <p>Additionally, with respect to your source code, the number of nested callbacks via completion handlers can increase to the point where it makes the code heavy and difficult to manage and understand.</p> <p>An MVVM architecture in combination with ReactiveCocoa 4 serves to provide solutions to all of these problems by</p> <ul> <li>Reducing the complexity of asynchronous operations by offering a streamlined paradigm for handling them via RAC4.</li> <li>Maintaining a consistent user experience by having data before it is needed or as fast as possible in the View Model.</li> <li>Improving code organization by distributing functions more evenly than in MVC.</li> </ul> <hr /> <p><strong>Let’s jump into making an MVVM-based mini app to display photos retrieved from a Parse backend.</strong></p> <p><strong>It’s going to display random photos from Parse using a view that is updated from a View Model where the photos are fetched using ReactiveCocoa 4.</strong></p> <hr /> <h2 id="making-a-view-model">Making a View Model</h2> <p>The essential components of a VM in Swift include a class to encapsulate the data that will be used by the UI. This can be in the form of properties to hold the data that will be used for presentation. In my implementation, the properties in the view controller mirror the properties of the View Model making for a 1:1 correspondence.</p> <p>Here is the outline for my View Model class in Swift.</p> <figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span></span><span class="lineno"> 1 </span><span class="kd">import</span> <span class="nc">Foundation</span>
<span class="lineno"> 2 </span><span class="kd">import</span> <span class="nc">ReactiveCocoa</span>
<span class="lineno"> 3 </span>
<span class="lineno"> 4 </span><span class="kd">protocol</span> <span class="nc">ViewModelUpdatable</span><span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
<span class="lineno"> 5 </span>    <span class="kd">func</span> <span class="nf">viewModelDidUpdate</span><span class="p">()</span>
<span class="lineno"> 6 </span><span class="p">}</span>
<span class="lineno"> 7 </span>
<span class="lineno"> 8 </span><span class="c1">/// A View Model class that holds photos that are retrieved asynchronously </span>
<span class="lineno"> 9 </span><span class="c1">/// from a backend.</span>
<span class="lineno">10 </span><span class="kd">class</span> <span class="nc">ViewModel</span><span class="p">:</span> <span class="bp">NSObject</span> <span class="p">{</span>
<span class="lineno">11 </span>    <span class="kd">static</span> <span class="kd">let</span> <span class="nv">sharedInstance</span> <span class="p">=</span> <span class="n">ViewModel</span><span class="p">()</span>
<span class="lineno">12 </span>    
<span class="lineno">13 </span>    <span class="c1">/// Used to update the UI via delegation.</span>
<span class="lineno">14 </span>    <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">delegate</span><span class="p">:</span> <span class="n">ViewModelUpdatable</span><span class="p">?</span>
<span class="lineno">15 </span>    
<span class="lineno">16 </span>    <span class="c1">/// Used to update the UI via KVO.</span>
<span class="lineno">17 </span>    <span class="kr">dynamic</span> <span class="kd">var</span> <span class="nv">somePhoto</span><span class="p">:</span> <span class="bp">UIImage</span><span class="p">?</span>
<span class="lineno">18 </span>    
<span class="lineno">19 </span>    <span class="c1">/// Load photos from a RAC4 signal.</span>
<span class="lineno">20 </span>    <span class="kd">func</span> <span class="nf">loadData</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno">21 </span>        <span class="n">DataLayer</span><span class="p">.</span><span class="n">sharedInstance</span><span class="p">.</span><span class="n">photoSignalProducer</span><span class="p">()</span>
<span class="lineno">22 </span>        <span class="p">.</span><span class="n">on</span><span class="p">(</span><span class="n">next</span><span class="p">:</span> <span class="p">{</span> <span class="n">next</span> <span class="k">in</span>
<span class="lineno">23 </span>            <span class="kc">self</span><span class="p">.</span><span class="n">kvoPhoto</span> <span class="p">=</span> <span class="n">next</span>
<span class="lineno">24 </span>
<span class="lineno">25 </span>            <span class="k">if</span> <span class="kc">self</span><span class="p">.</span><span class="n">kvoPhotoArray</span><span class="p">.</span><span class="bp">count</span> <span class="o">&gt;=</span> <span class="kc">self</span><span class="p">.</span><span class="n">photoLimit</span> <span class="p">{</span>
<span class="lineno">26 </span>                <span class="kc">self</span><span class="p">.</span><span class="n">kvoPhotoArray</span> <span class="p">=</span> <span class="p">[]</span>
<span class="lineno">27 </span>            <span class="p">}</span>
<span class="lineno">28 </span>
<span class="lineno">29 </span>            <span class="k">if</span> <span class="kd">let</span> <span class="nv">photo</span> <span class="p">=</span> <span class="n">next</span> <span class="p">{</span>
<span class="lineno">30 </span>                <span class="kc">self</span><span class="p">.</span><span class="n">kvoPhotoArray</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">photo</span><span class="p">)</span>
<span class="lineno">31 </span>            <span class="p">}</span>
<span class="lineno">32 </span>        <span class="p">},</span> <span class="n">completed</span><span class="p">:</span> <span class="p">{</span>
<span class="lineno">33 </span>            <span class="kc">self</span><span class="p">.</span><span class="n">timer</span><span class="p">?.</span><span class="n">invalidate</span><span class="p">()</span>
<span class="lineno">34 </span>        <span class="p">}).</span><span class="n">start</span><span class="p">()</span>
<span class="lineno">35 </span>    <span class="p">}</span>
<span class="lineno">36 </span><span class="p">}</span></code></pre></figure> <p>In my code, I’ve included both <strong>a protocol</strong> and <strong>a dynamic property</strong> for the purpose of implementing a couple of different ways of letting my UI know what to display.</p> <h3 id="two-ways-of-updating-the-ui-from-the-vm">Two ways of updating the UI from the VM</h3> <h4 id="observation-via-kvo">Observation via KVO</h4> <p>My VM inherits from <code>NSObject</code> so that KVO can be used on Swift properties declared as <code>dynamic</code>. The reason for this is so that properties in the <strong>View</strong> layer can be bound to the properties in the <strong>View Model</strong> layer. When these properties are bound, changes in the View Model are automatically reflected in the user interface.</p> <h4 id="delegation">Delegation</h4> <p>An alternative method of having the UI updated by the View Model is to use delegation. This is the reason I have listed the <code>ViewModelUpdatable</code> protocol that includes a function that can be called any time the UI is to be updated. In this case, my view controller subclass would conform to the protocol and implement the delegate method. The UI would then be updated by calling <code>delegate.viewModelDidUpdate()</code> in the VM.</p> <p>This method of delegation offers the most control over when to update the UI from the View Model.</p> <hr /> <h2 id="a-truly-minimal-view-controller-for-the-view-layer">A truly minimal view controller for the View layer</h2> <p>Instead of a view controller bloated with functions for handling data, MVVM offers the opportunity to have a truly minimal view controller by limiting the responsibility of the controller to only handling its views. All data is pre-processed for display by the VM layer.</p> <p>In my example view controller below, I have incorporated two methods for updating the views from the View Model.</p> <p>One method uses KVO as shown by my observer registrations and de-registrations along with the <code>observeValueForKeyPath:ofObject:change:context:</code> method to handle property changes as they occur.</p> <p>The other method uses delegation where the controller is conforming to <code>ViewModelUpdatable</code> and implementing the required delegate method <code>updateView</code>. The delegate method can then be called whenever the user interface needs to be updated by the View Model.</p> <figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span></span><span class="lineno"> 1 </span><span class="kd">import</span> <span class="nc">UIKit</span>
<span class="lineno"> 2 </span>
<span class="lineno"> 3 </span><span class="kd">class</span> <span class="nc">ViewController</span><span class="p">:</span> <span class="bp">UIViewController</span><span class="p">,</span> <span class="n">ViewModelUpdatable</span> <span class="p">{</span>
<span class="lineno"> 4 </span>    <span class="kr">@IBOutlet</span> <span class="kr">weak</span> <span class="kd">var</span> <span class="nv">imageView</span><span class="p">:</span> <span class="bp">UIImageView</span><span class="p">!</span>
<span class="lineno"> 5 </span>    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">kvoContext</span><span class="p">:</span> <span class="nb">UInt8</span> <span class="p">=</span> <span class="mi">1</span>
<span class="lineno"> 6 </span>    
<span class="lineno"> 7 </span>    <span class="c1">/// The View Model instance for this view controller.</span>
<span class="lineno"> 8 </span>    <span class="kd">let</span> <span class="nv">vm</span> <span class="p">=</span> <span class="n">ViewModel</span><span class="p">.</span><span class="n">sharedInstance</span> 
<span class="lineno"> 9 </span>    
<span class="lineno">10 </span>    <span class="kr">required</span> <span class="kd">init</span><span class="p">?(</span><span class="n">coder</span> <span class="n">aDecoder</span><span class="p">:</span> <span class="bp">NSCoder</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">11 </span>        <span class="kc">super</span><span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">coder</span><span class="p">:</span> <span class="n">aDecoder</span><span class="p">)</span>
<span class="lineno">12 </span>        <span class="n">vm</span><span class="p">.</span><span class="n">delegate</span> <span class="p">=</span> <span class="kc">self</span>
<span class="lineno">13 </span>        <span class="n">vm</span><span class="p">.</span><span class="n">addObserver</span><span class="p">(</span><span class="kc">self</span><span class="p">,</span> <span class="n">forKeyPath</span><span class="p">:</span> <span class="s">&quot;kvoPhoto&quot;</span><span class="p">,</span> 
<span class="lineno">14 </span>                       <span class="n">options</span><span class="p">:</span> <span class="p">.</span><span class="n">New</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">kvoContext</span><span class="p">)</span>
<span class="lineno">15 </span>    <span class="p">}</span>
<span class="lineno">16 </span>    
<span class="lineno">17 </span>    <span class="kd">deinit</span> <span class="p">{</span> <span class="n">vm</span><span class="p">.</span><span class="n">removeObserver</span><span class="p">(</span><span class="kc">self</span><span class="p">,</span> <span class="n">forKeyPath</span><span class="p">:</span> <span class="s">&quot;kvoPhoto&quot;</span><span class="p">)</span> <span class="p">}</span>
<span class="lineno">18 </span>    
<span class="lineno">19 </span>    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewWillAppear</span><span class="p">(</span><span class="n">animated</span><span class="p">:</span> <span class="nb">Bool</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">20 </span>        <span class="kc">super</span><span class="p">.</span><span class="n">viewWillAppear</span><span class="p">(</span><span class="n">animated</span><span class="p">)</span>
<span class="lineno">21 </span>        <span class="n">updateView</span><span class="p">()</span>
<span class="lineno">22 </span>    <span class="p">}</span>
<span class="lineno">23 </span>    
<span class="lineno">24 </span>    <span class="c1">/// Update the UI from the View Model using delegation in Swift.</span>
<span class="lineno">25 </span>    <span class="kd">func</span> <span class="nf">viewModelDidUpdate</span><span class="p">()</span> <span class="p">{</span> <span class="n">imageView</span><span class="p">.</span><span class="n">image</span> <span class="p">=</span> <span class="n">vm</span><span class="p">.</span><span class="n">kvoPhoto</span> <span class="p">}</span>
<span class="lineno">26 </span>    
<span class="lineno">27 </span>    <span class="c1">/// Update the UI from the View Model using KVO in Swift.</span>
<span class="lineno">28 </span>    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">observeValueForKeyPath</span><span class="p">(</span><span class="n">keyPath</span><span class="p">:</span> <span class="nb">String</span><span class="p">?,</span> 
<span class="lineno">29 </span>                                         <span class="n">ofObject</span> <span class="n">object</span><span class="p">:</span> <span class="nb">AnyObject</span><span class="p">?,</span> 
<span class="lineno">30 </span>                                         <span class="n">change</span><span class="p">:</span> <span class="p">[</span><span class="nb">String</span> <span class="p">:</span> <span class="nb">AnyObject</span><span class="p">]?,</span> 
<span class="lineno">31 </span>                                         <span class="n">context</span><span class="p">:</span> <span class="nb">UnsafeMutablePointer</span><span class="p">&lt;</span><span class="nb">Void</span><span class="p">&gt;)</span> <span class="p">{</span>
<span class="lineno">32 </span>        <span class="k">if</span> <span class="n">context</span> <span class="p">==</span> <span class="p">&amp;</span><span class="n">kvoContext</span> <span class="p">{</span>
<span class="lineno">33 </span>            <span class="k">if</span> <span class="kd">let</span> <span class="nv">chg</span> <span class="p">=</span> <span class="n">change</span> <span class="p">{</span>
<span class="lineno">34 </span>                <span class="k">if</span> <span class="n">keyPath</span> <span class="p">==</span> <span class="s">&quot;kvoPhoto&quot;</span> <span class="p">{</span>
<span class="lineno">35 </span>                  <span class="n">imageView</span><span class="p">.</span><span class="n">image</span> <span class="p">=</span> <span class="n">chg</span><span class="p">[</span><span class="s">&quot;new&quot;</span><span class="p">]</span> <span class="k">as</span><span class="p">?</span> <span class="bp">UIImage</span>
<span class="lineno">36 </span>                <span class="p">}</span>
<span class="lineno">37 </span>            <span class="p">}</span>
<span class="lineno">38 </span>        <span class="p">}</span>
<span class="lineno">39 </span>    <span class="p">}</span>
<span class="lineno">40 </span>    
<span class="lineno">41 </span>    <span class="kd">func</span> <span class="nf">updateView</span><span class="p">()</span> <span class="p">{</span> <span class="n">imageView</span><span class="p">.</span><span class="n">image</span> <span class="p">=</span> <span class="n">vm</span><span class="p">.</span><span class="n">kvoPhoto</span> <span class="p">}</span>
<span class="lineno">42 </span><span class="p">}</span></code></pre></figure> <h2 id="a-model-layer-with-a-parse-backend">A Model layer with a Parse backend</h2> <p>Finally, the data access layer corresponding to the Model in my MVVM architecture is implemented as a separate Swift class. It accesses the Parse.com backend to retrieve photos for the View Model.</p> <p>Using RAC4 gives us some conveniences by allowing the declaration of a <strong>result type</strong> for the signal producer that includes both the photo result along with any errors that occur during retrieval.</p> <p>A <code>shouldShowPhoto()</code> function is used to randomly choose a photo for display.</p> <figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span></span><span class="lineno"> 1 </span><span class="kd">import</span> <span class="nc">Foundation</span>
<span class="lineno"> 2 </span><span class="kd">import</span> <span class="nc">ReactiveCocoa</span>
<span class="lineno"> 3 </span><span class="kd">import</span> <span class="nc">Parse</span>
<span class="lineno"> 4 </span>
<span class="lineno"> 5 </span><span class="kd">enum</span> <span class="nc">DataError</span><span class="p">:</span> <span class="n">ErrorType</span> <span class="p">{</span>
<span class="lineno"> 6 </span>    <span class="k">case</span> <span class="n">parseQueryError</span><span class="p">(</span><span class="bp">NSError</span><span class="p">?)</span>
<span class="lineno"> 7 </span>    <span class="k">case</span> <span class="n">parseDataError</span><span class="p">(</span><span class="bp">NSError</span><span class="p">?)</span>
<span class="lineno"> 8 </span><span class="p">}</span>
<span class="lineno"> 9 </span>
<span class="lineno">10 </span><span class="kd">class</span> <span class="nc">DataLayer</span> <span class="p">{</span>
<span class="lineno">11 </span>    <span class="kd">static</span> <span class="kd">let</span> <span class="nv">sharedInstance</span> <span class="p">=</span> <span class="n">DataLayer</span><span class="p">()</span>
<span class="lineno">12 </span>    <span class="kd">var</span> <span class="nv">globalCounter</span> <span class="p">=</span> <span class="mi">0</span>
<span class="lineno">13 </span>    <span class="kd">var</span> <span class="nv">photoCount</span><span class="p">:</span> <span class="nb">UInt32</span> <span class="p">=</span> <span class="mi">5</span>
<span class="lineno">14 </span>
<span class="lineno">15 </span>    <span class="kd">func</span> <span class="nf">randomPhotoSignalProducer</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">SignalProducer</span><span class="p">&lt;</span><span class="bp">UIImage</span><span class="p">?,</span> <span class="n">DataError</span><span class="p">&gt;</span> <span class="p">{</span>
<span class="lineno">16 </span>        <span class="k">return</span> <span class="n">SignalProducer</span> <span class="p">{</span> <span class="n">observer</span><span class="p">,</span> <span class="n">disposable</span> <span class="k">in</span>
<span class="lineno">17 </span>            <span class="kd">let</span> <span class="nv">query</span> <span class="p">=</span> <span class="n">PFQuery</span><span class="p">(</span><span class="n">className</span><span class="p">:</span> <span class="s">&quot;TestPhoto&quot;</span><span class="p">)</span>
<span class="lineno">18 </span>            <span class="n">query</span><span class="p">.</span><span class="n">findObjectsInBackgroundWithBlock</span> <span class="p">{</span> <span class="n">objects</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
<span class="lineno">19 </span>                <span class="k">guard</span> <span class="kd">let</span> <span class="nv">objs</span> <span class="p">=</span> <span class="n">objects</span> <span class="k">where</span> <span class="n">error</span> <span class="p">==</span> <span class="kc">nil</span> <span class="k">else</span> <span class="p">{</span>
<span class="lineno">20 </span>                    <span class="n">observer</span><span class="p">.</span><span class="n">sendFailed</span><span class="p">(</span><span class="n">DataError</span><span class="p">.</span><span class="n">parseQueryError</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
<span class="lineno">21 </span>                    <span class="k">return</span>
<span class="lineno">22 </span>                <span class="p">}</span>
<span class="lineno">23 </span>                <span class="kd">var</span> <span class="nv">index</span> <span class="p">=</span> <span class="mi">0</span>
<span class="lineno">24 </span>                <span class="k">for</span> <span class="n">obj</span> <span class="k">in</span> <span class="n">objs</span> <span class="p">{</span>
<span class="lineno">25 </span>                    <span class="k">if</span> <span class="kc">self</span><span class="p">.</span><span class="n">shouldShowPhoto</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">photoCount</span><span class="p">:</span> <span class="n">photoCount</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">26 </span>                        <span class="k">if</span> <span class="kd">let</span> <span class="nv">photoFile</span> <span class="p">=</span> <span class="n">obj</span><span class="p">[</span><span class="s">&quot;photo&quot;</span><span class="p">]</span> <span class="p">{</span>
<span class="lineno">27 </span>                            <span class="n">photoFile</span><span class="p">.</span><span class="n">getDataInBackgroundWithBlock</span> <span class="p">{</span> <span class="n">data</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
<span class="lineno">28 </span>                                <span class="k">guard</span> <span class="kd">let</span> <span class="nv">photoData</span> <span class="p">=</span> <span class="n">data</span> <span class="k">where</span> <span class="n">error</span> <span class="p">==</span> <span class="kc">nil</span> <span class="k">else</span> <span class="p">{</span>
<span class="lineno">29 </span>                                    <span class="n">observer</span><span class="p">.</span><span class="n">sendFailed</span><span class="p">(</span><span class="n">DataError</span><span class="p">.</span><span class="n">parseDataError</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
<span class="lineno">30 </span>                                    <span class="k">return</span>
<span class="lineno">31 </span>                                <span class="p">}</span>
<span class="lineno">32 </span>                                <span class="n">observer</span><span class="p">.</span><span class="n">sendNext</span><span class="p">(</span><span class="bp">UIImage</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">photoData</span><span class="p">))</span>
<span class="lineno">33 </span>                            <span class="p">}</span>
<span class="lineno">34 </span>                        <span class="p">}</span>
<span class="lineno">35 </span>                        <span class="k">break</span>
<span class="lineno">36 </span>                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="n">index</span><span class="o">++</span> <span class="p">}</span>
<span class="lineno">37 </span>                <span class="p">}</span>
<span class="lineno">38 </span>            <span class="p">}</span>
<span class="lineno">39 </span>        <span class="p">}</span>
<span class="lineno">40 </span>    <span class="p">}</span>
<span class="lineno">41 </span>
<span class="lineno">42 </span>    <span class="kd">func</span> <span class="nf">shouldShowPhoto</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="nb">Int</span><span class="p">,</span> <span class="n">photoCount</span><span class="p">:</span> <span class="nb">UInt32</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Bool</span> <span class="p">{</span>
<span class="lineno">43 </span>        <span class="k">return</span> <span class="n">index</span> <span class="p">==</span> <span class="nb">Int</span><span class="p">(</span><span class="n">arc4random_uniform</span><span class="p">(</span><span class="n">photoCount</span><span class="p">))</span>
<span class="lineno">44 </span>    <span class="p">}</span>
<span class="lineno">45 </span><span class="p">}</span></code></pre></figure> <p>In my example, I’ve using both the View Model and Model layer in static instances via their ‘sharedInstance’ properties. This was for the purpose of testing the use of the View Model as pre-fetched data cache. Separating data handling from the view controller enables a complete VM to be ready before the view needs to be displayed.</p> <h2 id="summary">Summary</h2> <p>I’ve covered the main components of MVVM, illustrated in <strong>Figure 1</strong> and implemented using Swift and ReactiveCocoa 4.</p> <p>It’s the VM that separates MVVM from MVC. In my View Model, I’ve shown two methods of updating the user interface, <strong>observation via KVO</strong> and <strong>delegation</strong>. I’ve combined both of these methods in my example source code for the sake of comparison. Either method alone would be sufficient for getting data in the VM to be updated in the View layer. Using KVO requires that the VM inherits from <code>NSObject</code> and that properties are marked as <code>dynamic</code>.</p> <p>In iOS and OS X, the View layer consists of the view controller and its views where the view controller has the limited responsibility of handling views instead of interfacing with the Model layer as it would in the MVC paradigm.</p> <p>I’ve identified a few advantages in using an MVVM architecture implemented with RAC4.</p> <ul> <li>Reducing the complexity of asynchronous operations using ReactiveCocoa.</li> <li>Maintaining a consistent user experience by managing data in the VM.</li> <li>Improving code organization by distributing functions more evenly than with MVC.</li> </ul> <p>In my example, it can be seen that RAC4 is only used within the Model and View Model layers. This provides the added benefits of having the View layer be independent of more complex operations used to handle data and having data for views be testable without dependencies on the UI. In other words, an app could be tested without the explicit need for UI testing.</p> <p>MVVM, as I see it it, is not much different from MVC. I’ve shown that it can be implemented primarily by creating a separate data layer in the form of a View Model. You may have already created such a layer, such as for a data cache, without ever considering it as being a View Model. Now that you know how simple it is to move between MVC and MVVM, I hope that you’ll have the flexibility to explore how each paradigm can apply to your apps.</p> </div> <ul class="tag_box inline"> <li><i class="icon-folder-open"></i></li> <li><a href="/categories#experiences-ref"> experiences <span>6</span> </a></li> </ul> <ul class="tag_box inline"> <li><i class="icon-tags"></i></li> <li><a href="/tags#mvvm-ref">mvvm <span>1</span></a></li> <li><a href="/tags#swift-ref">swift <span>12</span></a></li> <li><a href="/tags#reactivecocoa-4-ref">reactivecocoa-4 <span>4</span></a></li> <li><a href="/tags#ios-ref">ios <span>9</span></a></li> <li><a href="/tags#osx-ref">osx <span>8</span></a></li> <li><a href="/tags#asynchronous-operations-ref">asynchronous-operations <span>4</span></a></li> </ul> <hr> <ul class="pagination"> <li class="prev"><a href="/tips/2016/01/10/cancel-button-for-google-drive-login" title="Making It So Users Can Cancel a Google Drive Login on iOS 9">&larr; Previous</a></li> <li><a href="/archive">Archive</a></li> <li class="next"><a href="/experiences/2016/02/01/signal-chaining-in-reactivecocoa-4-for-cloudkit" title="Signal Chaining in ReactiveCocoa 4 for CloudKit">Next &rarr;</a></li> </ul> <hr> <div id="disqus_thread"></div> <script type="text/javascript"> var disqus_developer = 1; var disqus_shortname = 'ikiapps'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a> </div> </div> <hr/> <footer> <div style="float: left; margin-top: 10px; margin-bottom: 45px;"> &copy; 2019 ikiApps LLC</div> <div style="float: right; margin-top: 10px; margin-bottom: 40px;"><a href="/contact" target="_blank">Contact</a></div> <div style="float: left; margin-top: 10px; margin-bottom: 40px;"><hr/></div> </footer> </div> <script src="/assets/themes/bootstrap/resources/bootstrap/js/bootstrap.min.js"></script> </body> </html>
