<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width initial-scale=1"> <meta name="author" content="ikiApps LLC, 粋アプリ, d108(सोऽहम्)"> <meta name="description" content="With Parse going away, the quest for alternatives begins. CloudKit is one option. No matter what backend one may choose, there are inherent frailties within ..."> <title>Signal Chaining in ReactiveCocoa 4 for CloudKit</title> <link href="/assets/themes/bootstrap/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet"> <!--[if lt IE 9]> <script src="/assets/themes/bootstrap/resources/respond/Respond.min.js"></script> <![endif]--> <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed"> <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed"> <link rel="stylesheet" href="/css/main.css" type="text/css"> <link rel="canonical" href="/experiences/2016/02/01/signal-chaining-in-reactivecocoa-4-for-cloudkit"> <link rel="shortcut icon" href="/favicon.ico"> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-40712418-2', 'auto'); ga('send', 'pageview'); </script> <script src="/js/jquery-3.2.0.min.js"></script> </head> <body> <nav class="navbar navbar-default" role="navigation"> <div class="container"> <div class="navbar-header"> <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <div class="navbar-image"><a href="/"><img src="/assets/themes/bootstrap/iki-circle-logo.png" width="40"/></a></div> <a class="navbar-brand" href="/">ikiApps</a> </div> <div class="collapse navbar-collapse navbar-ex1-collapse"> <ul class="nav navbar-nav"> <li><a href="/blog/">Blog</a></li> <li><a href="/archive">Archive</a></li> <li><a href="/tags">Tags</a></li> <li><a href="/search/">Search</a></li> </ul> </div> </div> </nav> <div class="container"> <div class="page-header"> <h1>Signal Chaining in ReactiveCocoa 4 for CloudKit <br/><small>Reduce Points of Failure in Your App with Signals</small></h1> </div> <div class="row post-full"> <div class="col-md-12"> <div class="date"> <span>01 February 2016</span> </div> <div class="content"> <p>With <a href="http://blog.parse.com/announcements/moving-on/">Parse going away</a>, the quest for alternatives begins. <a href="https://developer.apple.com/icloud/">CloudKit</a> is one option. No matter what backend one may choose, there are inherent frailties within any app that relies on a backend. Sometimes these weaknesses are only revealed under significant loads or unusual usage patterns and are often a result of a flawed handling of concurrency.</p> <p>Given the full toolset of delegation, observation, completion handlers, Grand Central Dispatch (GCD) and NSOperations, just about any concurrency situation can be handled. However, the natural complexity involved in employing those tools can lead to subtle flaws that are difficult to reproduce.</p> <p><strong>This is where ReactiveCocoa and a signal chaining approach can offer improvement.</strong> RAC is not necessarily a replacement for the existing tools. Instead it offers an added value environment that allows implementations to be even more functional, in the functional programming sense, than otherwise possible. I’m going to use a typical set of backend operations to illustrate how a functional reactive approach can minimize points of failure within a typical set of linked backend operations.</p> <hr /> <p>Before I get into that, I want to make a few comments about Swift and ReactiveCocoa.</p> <p>Swift has made ReactiveCocoa more accessible to me because it is free from the cumbersome syntax of Objective-C. Additionally, static typing has improved my ability to relate to everything within the language, perhaps that is just due to my personal preferences.</p> <p>There are still some barriers such as the code not reading in a way that is natural to me. For example, signals are chained by returning other signals within Swift closures and that still seems strange but I’m starting to be more comfortable with it.</p> <p>As long as I remember that the syntax is an ends to a mean, a vehicle to reach a destination, then it becomes more pleasant to work with. The other benefits that Swift offers make up for the slight awkward syntax that results from fitting Swift into a functional reactive approach.</p> <p>The integration of RAC4 with Swift’s type system is a huge improvement over the previous Objective-C version and truly assists in areas such as propagating errors through a signal chain. Xcode’s handling of Swift types is also extremely helpful when it comes to writing code. Xcode’s documentation features for Swift types is great as I show in an example for the <code>.on()</code> function in Figure 1.</p> <p> <figure class="image"><img src="/img/2016-02-01-signal-chaining-in-reactivecocoa-4-for-cloudkit/type-hints-for-rac4-in-xcode.png" alt="Figure 1: Xcode showing type hints for ReactiveCocoa 4.The function types shown here are an example of how RAC4 makes use of Swift's static type system. Having these hints is the greatest thing to me. The types make it possible to keep track of signals in a way that wasn’t possible before." /> <figcaption><strong>Figure 1: Xcode showing type hints for ReactiveCocoa 4.</strong> The function types shown here are an example of how RAC4 makes use of Swift's static type system. Having these hints is the greatest thing to me. The types make it possible to keep track of signals in a way that wasn’t possible before.</figcaption> </figure> </p> <hr /> <h2 id="example-implementation-of-cloudkit-functions">Example implementation of CloudKit functions</h2> <p>For my example, I’m going to cover a typical operation when working with any backend, <strong>deleting records.</strong> I’ll be using CloudKit as my backend.</p> <p>As an initial, not functional reactive solution, we could retrieve the record IDs into an array and then iterate over that array to delete the matching records.</p> <p>For my test scenario, I’ll need to first add records on every run.</p> <p>These operations amount to three distinct functions.</p> <ul> <li>Add test records.</li> <li>Retrieve records matching some query.</li> <li>Perform deletions of records.</li> </ul> <p>I’ve provided sample code for these three functions here.</p> <figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span></span><span class="lineno"> 1 </span><span class="c1">/// Add a test photo record into the public DB.</span>
<span class="lineno"> 2 </span><span class="kd">func</span> <span class="nf">addTestPhoto</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno"> 3 </span>    <span class="kd">let</span> <span class="nv">recordID</span> <span class="p">=</span> <span class="bp">CKRecordID</span><span class="p">(</span><span class="n">recordName</span><span class="p">:</span> <span class="n">getUUID</span><span class="p">())</span>
<span class="lineno"> 4 </span>    <span class="kd">let</span> <span class="nv">photo</span> <span class="p">=</span> <span class="bp">CKRecord</span><span class="p">(</span><span class="n">recordType</span><span class="p">:</span> <span class="n">TypeConstants</span><span class="p">.</span><span class="n">TestPhoto</span><span class="p">,</span> <span class="n">recordID</span><span class="p">:</span> <span class="n">recordID</span><span class="p">)</span>
<span class="lineno"> 5 </span>    <span class="n">publicDB</span><span class="p">.</span><span class="n">saveRecord</span><span class="p">(</span><span class="n">photo</span><span class="p">)</span> <span class="p">{</span> <span class="n">record</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
<span class="lineno"> 6 </span>        <span class="k">guard</span> <span class="n">error</span> <span class="p">==</span> <span class="kc">nil</span> <span class="k">else</span> <span class="p">{</span>
<span class="lineno"> 7 </span>            <span class="c1">// Handle the error.</span>
<span class="lineno"> 8 </span>            <span class="k">return</span>
<span class="lineno"> 9 </span>        <span class="p">}</span>
<span class="lineno">10 </span>    <span class="p">}</span>
<span class="lineno">11 </span><span class="p">}</span></code></pre></figure> <figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span></span><span class="lineno"> 1 </span><span class="c1">/// Get all of the photos in the public DB and place the results in an Array.</span>
<span class="lineno"> 2 </span><span class="kd">func</span> <span class="nf">getAllPhotos</span><span class="p">(</span><span class="n">completionWithPhotos</span><span class="p">:</span> <span class="p">(</span><span class="n">photos</span><span class="p">:</span> <span class="p">[</span><span class="bp">CKRecord</span><span class="p">])-&gt;())</span> <span class="p">{</span>
<span class="lineno"> 3 </span>    <span class="kd">var</span> <span class="nv">result</span> <span class="p">=</span> <span class="nb">Array</span><span class="p">&lt;</span><span class="bp">CKRecord</span><span class="p">&gt;()</span>
<span class="lineno"> 4 </span>    <span class="kd">let</span> <span class="nv">photoPredicate</span> <span class="p">=</span> <span class="bp">NSPredicate</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
<span class="lineno"> 5 </span>    <span class="kd">let</span> <span class="nv">query</span> <span class="p">=</span> <span class="bp">CKQuery</span><span class="p">(</span><span class="n">recordType</span><span class="p">:</span> <span class="n">TypeConstants</span><span class="p">.</span><span class="n">TestPhoto</span><span class="p">,</span> 
<span class="lineno"> 6 </span>                        <span class="n">predicate</span><span class="p">:</span> <span class="n">photoPredicate</span><span class="p">)</span>
<span class="lineno"> 7 </span>    <span class="n">publicDB</span><span class="p">.</span><span class="n">performQuery</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">inZoneWithID</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">{</span> <span class="n">records</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
<span class="lineno"> 8 </span>        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">foundRecords</span> <span class="p">=</span> <span class="n">records</span> <span class="k">where</span> <span class="n">error</span> <span class="p">==</span> <span class="kc">nil</span> <span class="k">else</span> <span class="p">{</span>
<span class="lineno"> 9 </span>            <span class="c1">// Handle the error.</span>
<span class="lineno">10 </span>            <span class="k">return</span>
<span class="lineno">11 </span>        <span class="p">}</span>
<span class="lineno">12 </span>        <span class="k">for</span> <span class="n">record</span> <span class="k">in</span> <span class="n">foundRecords</span> <span class="p">{</span>
<span class="lineno">13 </span>            <span class="n">result</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
<span class="lineno">14 </span>        <span class="p">}</span>
<span class="lineno">15 </span>        <span class="n">completionWithPhotos</span><span class="p">(</span><span class="n">photos</span><span class="p">:</span> <span class="n">result</span><span class="p">)</span>
<span class="lineno">16 </span>    <span class="p">}</span>
<span class="lineno">17 </span><span class="p">}</span></code></pre></figure> <figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span></span><span class="lineno">1 </span><span class="c1">/// Delete a record from the public DB.</span>
<span class="lineno">2 </span><span class="kd">func</span> <span class="nf">deleteRecord</span><span class="p">(</span><span class="n">recordID</span><span class="p">:</span> <span class="bp">CKRecordID</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">3 </span>    <span class="n">publicDB</span><span class="p">.</span><span class="n">deleteRecordWithID</span><span class="p">(</span><span class="n">recordID</span><span class="p">,</span> <span class="n">completionHandler</span><span class="p">:</span> <span class="p">{</span> <span class="n">recordID</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
<span class="lineno">4 </span>        <span class="k">guard</span> <span class="n">error</span> <span class="p">==</span> <span class="kc">nil</span> <span class="k">else</span> <span class="p">{</span>
<span class="lineno">5 </span>            <span class="c1">// Handle the error.</span>
<span class="lineno">6 </span>            <span class="k">return</span>
<span class="lineno">7 </span>        <span class="p">}</span>
<span class="lineno">8 </span>    <span class="p">})</span>
<span class="lineno">9 </span><span class="p">}</span></code></pre></figure> <p>Deleting the records that are retrieved using <code>getAllPhotos()</code> requires that the result is passed to <code>deleteRecord()</code>. This is where potential points of failure can be introduced using approaches typical to iOS and OS X development.</p> <p>Due to the asynchronous nature of both retrieving records from the backend and the deletion of those records, getting the two functions to talk to each other can be accomplished in a couple of ways:</p> <ul> <li>Through the completion handler of <code>getAllPhotos()</code>.</li> <li>Through a property that holds an array of record IDs.</li> </ul> <p>In both of these cases, it will be found that we have to loop over some collection to perform the deletion.</p> <p>Here is how it looks using a property, <code>self.recordIDs</code>, that is an array of record IDs.</p> <figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span></span><span class="lineno"> 1 </span><span class="c1">/// Delete all records matching recordIDs in self.recordIDs. </span>
<span class="lineno"> 2 </span><span class="kd">func</span> <span class="nf">deleteAllRecords</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno"> 3 </span>    <span class="k">for</span> <span class="n">recordID</span> <span class="k">in</span> <span class="kc">self</span><span class="p">.</span><span class="n">recordIDs</span> <span class="p">{</span>
<span class="lineno"> 4 </span>        <span class="n">publicDB</span><span class="p">.</span><span class="n">deleteRecordWithID</span><span class="p">(</span><span class="n">recordID</span><span class="p">,</span> <span class="n">completionHandler</span><span class="p">:</span> <span class="p">{</span> <span class="n">recordID</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
<span class="lineno"> 5 </span>            <span class="k">guard</span> <span class="n">error</span> <span class="p">==</span> <span class="kc">nil</span> <span class="k">else</span> <span class="p">{</span>
<span class="lineno"> 6 </span>                <span class="c1">// Handle the error</span>
<span class="lineno"> 7 </span>                <span class="k">return</span>
<span class="lineno"> 8 </span>            <span class="p">}</span>
<span class="lineno"> 9 </span>        <span class="p">})</span>
<span class="lineno">10 </span>    <span class="p">}</span>
<span class="lineno">11 </span><span class="p">}</span></code></pre></figure> <p>In this case, we would have had to have loaded the records from CloudKit into <code>self.recordIDs</code> ahead of time.</p> <p>If we instead use the completion handler we could use a function like the one below.</p> <figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span></span><span class="lineno">1 </span><span class="c1">/// Delete all records that are retrieved by getAllPhotos() using its </span>
<span class="lineno">2 </span><span class="c1">/// completion handler.</span>
<span class="lineno">3 </span><span class="kd">func</span> <span class="nf">deleteAllPhotos</span><span class="p">()</span> <span class="p">{</span>
<span class="lineno">4 </span>    <span class="n">getAllPhotos</span> <span class="p">{</span> <span class="n">photos</span> <span class="k">in</span>
<span class="lineno">5 </span>        <span class="k">for</span> <span class="n">photo</span> <span class="k">in</span> <span class="n">photos</span> <span class="p">{</span>
<span class="lineno">6 </span>            <span class="kc">self</span><span class="p">.</span><span class="n">deleteRecord</span><span class="p">(</span><span class="n">photo</span><span class="p">.</span><span class="n">recordID</span><span class="p">)</span>
<span class="lineno">7 </span>        <span class="p">}</span>
<span class="lineno">8 </span>    <span class="p">}</span>
<span class="lineno">9 </span><span class="p">}</span></code></pre></figure> <p>A function here, a property there. This doesn’t seem that bad but over the course of development, all these little additions start to add up. In the worst case, your app’s complexity starts increasing exponentially due to needing to manage all of this additional code every time a change is made.</p> <p>I’ve seen implementations like this fail under heavy usage even though it can be fine under lighter loads.</p> <p>Enter ReactiveCocoa.</p> <h2 id="reactivecocoa-4-implementation-of-cloudkit-record-deleting">ReactiveCocoa 4 implementation of CloudKit record deleting</h2> <p>The immediate reason for my stepping into ReactiveCocoa is that it offers a more functional approach that implies greater reliability and elegance in concurrency implementations. The following benefits can be obtained as a result.</p> <ul> <li>Reducing the lines of code that are actively involved in operations.</li> <li>Removing intermediary variable allocations that can be points of failure during concurrent operations.</li> <li>Gaining unified error handling and cancellations.</li> </ul> <p>Instead of adding to the operational complexity of an app, using ReactiveCocoa can have the effect of reducing it.</p> <h3 id="function-modifications-for-reactivecocoa">Function modifications for ReactiveCocoa</h3> <h3 id="retrieve-all-photos-modifications-for-rac">Retrieve all photos modifications for RAC</h3> <p>Retrieving all photos in our app can be accomplished with a signal producer that calls our existing photo retrieval function.</p> <p>In the process, the <strong>completion handler can be eliminated</strong> from that function thereby eliminating a potential source of error.</p> <p>Here is the <code>getAllPhotos()</code> function when used with ReactiveCocoa. The observer is passed into the function so that the function can send events on the signal.</p> <figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span></span><span class="lineno"> 1 </span><span class="kd">func</span> <span class="nf">getAllPhotos</span><span class="p">(</span><span class="n">observer</span><span class="p">:</span> <span class="n">Observer</span><span class="p">&lt;</span><span class="bp">CKRecordID</span><span class="p">,</span> <span class="bp">NSError</span><span class="p">&gt;)</span> <span class="p">{</span>
<span class="lineno"> 2 </span>    <span class="kd">let</span> <span class="nv">photoPredicate</span> <span class="p">=</span> <span class="bp">NSPredicate</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
<span class="lineno"> 3 </span>    <span class="kd">let</span> <span class="nv">query</span> <span class="p">=</span> <span class="bp">CKQuery</span><span class="p">(</span><span class="n">recordType</span><span class="p">:</span> <span class="n">TypeConstants</span><span class="p">.</span><span class="n">TestPhoto</span><span class="p">,</span> <span class="n">predicate</span><span class="p">:</span> <span class="n">photoPredicate</span><span class="p">)</span>
<span class="lineno"> 4 </span>    <span class="n">publicDB</span><span class="p">.</span><span class="n">performQuery</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">inZoneWithID</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">{</span> <span class="n">records</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
<span class="lineno"> 5 </span>        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">foundRecords</span> <span class="p">=</span> <span class="n">records</span> <span class="k">where</span> <span class="n">error</span> <span class="p">==</span> <span class="kc">nil</span> <span class="k">else</span> <span class="p">{</span>
<span class="lineno"> 6 </span>            <span class="n">observer</span><span class="p">.</span><span class="n">sendFailed</span><span class="p">(</span><span class="n">error</span><span class="p">!)</span>
<span class="lineno"> 7 </span>            <span class="k">return</span>
<span class="lineno"> 8 </span>        <span class="p">}</span>
<span class="lineno"> 9 </span>        <span class="k">for</span> <span class="n">record</span> <span class="k">in</span> <span class="n">foundRecords</span> <span class="p">{</span>
<span class="lineno">10 </span>            <span class="n">observer</span><span class="p">.</span><span class="n">sendNext</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="n">recordID</span><span class="p">)</span>
<span class="lineno">11 </span>        <span class="p">}</span>
<span class="lineno">12 </span>        <span class="n">observer</span><span class="p">.</span><span class="n">sendCompleted</span><span class="p">()</span>
<span class="lineno">13 </span>    <span class="p">}</span>
<span class="lineno">14 </span><span class="p">}</span></code></pre></figure> <h5 id="giving-errors-the-care-they-deserve">Giving errors the care they deserve</h5> <p>In addition to removing the completion handler, we have gained a result type that will propagate an error if it occurs through the rather elegant <code>sendFailed()</code> method. This is much better than handling the error in a completion handler because it will be sent up the entire signal chain. Too often, errors are left unhandled due to the extra work that is involved. ReactiveCocoa minimizes the effort required to setup error handling and this can mean that more errors will be treated properly.</p> <h4 id="add-photo-and-delete-record-modifications-for-rac">Add photo and delete record modifications for RAC</h4> <p>I altered the photo adding and deleting functions, in a likewise manner, to include the observer argument to be able to send events on a signal.</p> <figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span></span><span class="lineno"> 1 </span><span class="c1">/// Photo add function modified for use with ReactiveCocoa.</span>
<span class="lineno"> 2 </span><span class="kd">func</span> <span class="nf">addTestPhoto</span><span class="p">(</span><span class="n">observer</span><span class="p">:</span> <span class="n">Observer</span><span class="o">&lt;</span><span class="p">(),</span> <span class="bp">NSError</span><span class="p">&gt;)</span> <span class="p">{</span>
<span class="lineno"> 3 </span>    <span class="kd">let</span> <span class="nv">recordID</span> <span class="p">=</span> <span class="bp">CKRecordID</span><span class="p">(</span><span class="n">recordName</span><span class="p">:</span> <span class="n">getUUID</span><span class="p">())</span>
<span class="lineno"> 4 </span>    <span class="kd">let</span> <span class="nv">photo</span> <span class="p">=</span> <span class="bp">CKRecord</span><span class="p">(</span><span class="n">recordType</span><span class="p">:</span> <span class="n">TypeConstants</span><span class="p">.</span><span class="n">TestPhoto</span><span class="p">,</span> <span class="n">recordID</span><span class="p">:</span> <span class="n">recordID</span><span class="p">)</span>
<span class="lineno"> 5 </span>    <span class="n">publicDB</span><span class="p">.</span><span class="n">saveRecord</span><span class="p">(</span><span class="n">photo</span><span class="p">)</span> <span class="p">{</span> <span class="n">record</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
<span class="lineno"> 6 </span>        <span class="k">guard</span> <span class="n">error</span> <span class="p">==</span> <span class="kc">nil</span> <span class="k">else</span> <span class="p">{</span>
<span class="lineno"> 7 </span>            <span class="n">observer</span><span class="p">.</span><span class="n">sendFailed</span><span class="p">(</span><span class="n">error</span><span class="p">!)</span>
<span class="lineno"> 8 </span>            <span class="k">return</span>
<span class="lineno"> 9 </span>        <span class="p">}</span>
<span class="lineno">10 </span>        <span class="n">observer</span><span class="p">.</span><span class="n">sendCompleted</span><span class="p">()</span>
<span class="lineno">11 </span>    <span class="p">}</span>
<span class="lineno">12 </span><span class="p">}</span></code></pre></figure> <figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span></span><span class="lineno"> 1 </span><span class="c1">/// Record delete function modified for use with ReactiveCocoa. </span>
<span class="lineno"> 2 </span><span class="kd">func</span> <span class="nf">deleteRecord</span><span class="p">(</span><span class="n">recordID</span><span class="p">:</span> <span class="bp">CKRecordID</span><span class="p">,</span> <span class="n">observer</span><span class="p">:</span> <span class="n">Observer</span><span class="p">&lt;</span><span class="bp">CKRecordID</span><span class="p">,</span> <span class="bp">NSError</span><span class="p">&gt;)</span> <span class="p">{</span>
<span class="lineno"> 3 </span>    <span class="n">publicDB</span><span class="p">.</span><span class="n">deleteRecordWithID</span><span class="p">(</span><span class="n">recordID</span><span class="p">,</span> <span class="n">completionHandler</span><span class="p">:</span> <span class="p">{</span> <span class="n">recordID</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
<span class="lineno"> 4 </span>        <span class="k">guard</span> <span class="n">error</span> <span class="p">==</span> <span class="kc">nil</span> <span class="k">else</span> <span class="p">{</span>
<span class="lineno"> 5 </span>            <span class="n">observer</span><span class="p">.</span><span class="n">sendFailed</span><span class="p">(</span><span class="n">error</span><span class="p">!)</span>
<span class="lineno"> 6 </span>            <span class="k">return</span>
<span class="lineno"> 7 </span>        <span class="p">}</span>
<span class="lineno"> 8 </span>        <span class="n">observer</span><span class="p">.</span><span class="n">sendCompleted</span><span class="p">()</span>
<span class="lineno"> 9 </span>    <span class="p">})</span>
<span class="lineno">10 </span><span class="p">}</span></code></pre></figure> <h3 id="wrapping-our-existing-functions-into-signal-producers">Wrapping our existing functions into signal producers</h3> <p>The <strong>Signal Producer</strong> for this method is then implemented by the following function.</p> <figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span></span><span class="lineno">1 </span><span class="c1">/// Make a signal for adding test photos to CloudKit.</span>
<span class="lineno">2 </span><span class="kd">func</span> <span class="nf">testPhotoAdder</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">SignalProducer</span><span class="o">&lt;</span><span class="p">(),</span> <span class="bp">NSError</span><span class="p">&gt;</span> <span class="p">{</span>
<span class="lineno">3 </span>    <span class="k">return</span> <span class="n">SignalProducer</span> <span class="p">{</span> <span class="n">observer</span><span class="p">,</span> <span class="n">disposable</span> <span class="k">in</span>
<span class="lineno">4 </span>        <span class="n">addTestPhoto</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span>
<span class="lineno">5 </span>    <span class="p">}</span>
<span class="lineno">6 </span><span class="p">}</span></code></pre></figure> <p>A <strong>Signal Producer</strong> for deleting photos can be similarly implemented.</p> <figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span></span><span class="lineno">1 </span><span class="c1">/// Make a signal for deleting records from CloudKit.</span>
<span class="lineno">2 </span><span class="kd">func</span> <span class="nf">photoDeleter</span><span class="p">(</span><span class="n">recordID</span><span class="p">:</span> <span class="bp">CKRecordID</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">SignalProducer</span><span class="p">&lt;</span><span class="bp">CKRecordID</span><span class="p">,</span> <span class="bp">NSError</span><span class="p">&gt;</span> <span class="p">{</span>
<span class="lineno">3 </span>    <span class="k">return</span> <span class="n">SignalProducer</span> <span class="p">{</span> <span class="n">observer</span><span class="p">,</span> <span class="n">disposable</span> <span class="k">in</span>
<span class="lineno">4 </span>        <span class="n">deleteRecord</span><span class="p">(</span><span class="n">recordID</span><span class="p">)</span>
<span class="lineno">5 </span>    <span class="p">}</span>
<span class="lineno">6 </span><span class="p">}</span></code></pre></figure> <h3 id="final-form-of-the-record-deleting-signal">Final form of the record deleting signal</h3> <p>The real magic occurs when the results of the photo retrieval signal are passed to the record deleting signal without the use of intermediary storage and without need for a completion handler.</p> <figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span></span><span class="lineno">1 </span><span class="c1">/// A signal producer to retrieve records and delete them.</span>
<span class="lineno">2 </span><span class="kd">let</span> <span class="nv">deletedPhotos</span>
<span class="lineno">3 </span>    <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">photosGetter</span><span class="p">().</span><span class="n">flatMap</span><span class="p">(</span><span class="n">FlattenStrategy</span><span class="p">.</span><span class="n">Merge</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">4 </span>        <span class="n">recordID</span> <span class="p">-&gt;</span> <span class="n">SignalProducer</span><span class="p">&lt;</span><span class="bp">CKRecordID</span><span class="p">,</span> <span class="bp">NSError</span><span class="p">&gt;</span> <span class="k">in</span>
<span class="lineno">5 </span>            <span class="k">return</span> <span class="kc">self</span><span class="p">.</span><span class="n">photoDeleter</span><span class="p">(</span><span class="n">recordID</span><span class="p">)</span>
<span class="lineno">6 </span><span class="p">}</span></code></pre></figure> <p>The <code>flatMap()</code> here converts the events of the photo retrieval signal into the signal producer that deletes individual records in CloudKit. The two signals are talking to each other directly without any intermediaries. Code friction is reduced to a minimum making for a smooth ride.</p> <p>The last thing that remains is to call <code>start()</code> on <code>deletedPhotos</code> after test photos have been added to CloudKit. The following code accomplishes this where I’ve used a comparatively inelegant form of ordering the operations in sequence through the RAC-based completion handler for signals.</p> <figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span></span><span class="lineno">1 </span><span class="c1">/// The photo deleting signal is started after the test photos are added to the </span>
<span class="lineno">2 </span><span class="c1">/// backend.</span>
<span class="lineno">3 </span><span class="kc">self</span><span class="p">.</span><span class="n">testPhotoAdder</span><span class="p">().</span><span class="n">startWithCompleted</span> <span class="p">{</span>
<span class="lineno">4 </span>    <span class="kc">self</span><span class="p">.</span><span class="n">testPhotoAdder</span><span class="p">().</span><span class="n">startWithCompleted</span> <span class="p">{</span>
<span class="lineno">5 </span>        <span class="n">deletedPhotos</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
<span class="lineno">6 </span>    <span class="p">}</span>
<span class="lineno">7 </span><span class="p">}</span></code></pre></figure> <h2 id="summary-of-reactivecocoa-signal-chaining-benefits">Summary of ReactiveCocoa signal chaining benefits</h2> <p>Chaining signals by returning a signal has been a slippery concept to grasp for me. I understand it is done that way so that it fits into Swift. Instead of getting hung up on the syntax, I am focused on obtaining results according to the theory that is well documented within the <a href="https://github.com/ReactiveCocoa/ReactiveCocoa">ReactiveCocoa repository</a>.</p> <p>If you can wrap your head around it, the end result can be thoroughly worth it.</p> <h3 id="eliminating-unnecessary-completion-handlers">Eliminating unnecessary completion handlers</h3> <p>Eliminating the need for defining a completion handler is extraordinary considering how many such handlers might be needed without the use of signals in ReactiveCocoa.</p> <p>Here are a few reasons to reduce use of completion handlers:</p> <ul> <li>Unexpected results can occur when a completion occurs at an unexpected point in time.</li> <li>Propagating errors through multiple handlers is an exercise in patience.</li> <li>Code is made more readable by removing extraneous usages.</li> </ul> <h3 id="improving-error-handling">Improving error handling</h3> <p>Regarding error propagation, the unified error handling that is gained through ReactiveCocoa is a benefit that can be immediately realized.</p> <h3 id="reducing-intermediary-allocations">Reducing intermediary allocations</h3> <p>Using signals has the added benefit of eliminating the need for intermediate memory allocations for variables such as arrays used for processing values. This eliminates yet another potential source of failure during concurrent operations.</p> <h3 id="reducing-overall-code-complexity">Reducing overall code complexity</h3> <p>The overall result of using ReactiveCocoa signals is that the overall operational complexity of an app can be reduced. This ends up giving the following advantages to an app.</p> <ul> <li>Maintainability is made easier.</li> <li>Failures are reduced.</li> <li>User experience is improved.</li> </ul> <h3 id="final-opinion">Final opinion</h3> <p>It requires fairly comprehensive experience with concurrency in iOS and OS X to appreciate the advantages that ReactiveCocoa offers. ReactiveCocoa 4 makes sense to me in Swift even if the syntax is slightly awkward. Due to Swift’s type safety, RAC4 coding is significantly aided by Xcode (minus the SourceKit crashes). I’m not able to say the same about the Objective-C version.</p> <p>My purpose in this post was to demonstrate how ReactiveCocoa can improve a typical backend implementation in a way that wouldn’t otherwise be practical using the conventional concurrency toolset in iOS and OS X. I used CloudKit for my example, but other backends would be handled similarly. There is an upfront cost to adapting existing code to use ReactiveCocoa signals but the long-term benefits that I have covered can justify that initial investment.</p> </div> <ul class="tag_box inline"> <li><i class="icon-folder-open"></i></li> <li><a href="/categories#experiences-ref"> experiences <span>6</span> </a></li> </ul> <ul class="tag_box inline"> <li><i class="icon-tags"></i></li> <li><a href="/tags#reactivecocoa-ref">reactivecocoa <span>1</span></a></li> <li><a href="/tags#reactivecocoa-4-ref">reactivecocoa-4 <span>4</span></a></li> <li><a href="/tags#cloudkit-ref">cloudkit <span>1</span></a></li> <li><a href="/tags#swift-ref">swift <span>12</span></a></li> <li><a href="/tags#ios-ref">ios <span>9</span></a></li> <li><a href="/tags#osx-ref">osx <span>8</span></a></li> <li><a href="/tags#concurrency-ref">concurrency <span>3</span></a></li> <li><a href="/tags#asynchronous-operations-ref">asynchronous-operations <span>4</span></a></li> </ul> <hr> <ul class="pagination"> <li class="prev"><a href="/experiences/2016/01/15/mvvm-in-swift-with-reactivecocoa4" title="MVVM in Swift with ReactiveCocoa 4">&larr; Previous</a></li> <li><a href="/archive">Archive</a></li> <li class="next"><a href="/tips/2016/02/02/easy-install-rac4-with-cocoapods" title="Easy Install of ReactiveCocoa 4 Using CocoaPods">Next &rarr;</a></li> </ul> <hr> <div id="disqus_thread"></div> <script type="text/javascript"> var disqus_developer = 1; var disqus_shortname = 'ikiapps'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a> </div> </div> <hr/> <footer> <div style="float: left; margin-top: 10px; margin-bottom: 45px;"> &copy; 2019 ikiApps LLC</div> <div style="float: right; margin-top: 10px; margin-bottom: 40px;"><a href="/contact" target="_blank">Contact</a></div> <div style="float: left; margin-top: 10px; margin-bottom: 40px;"><hr/></div> </footer> </div> <script src="/assets/themes/bootstrap/resources/bootstrap/js/bootstrap.min.js"></script> </body> </html>
